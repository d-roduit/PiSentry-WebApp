<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PiSentry WebApp</title>
    <link href="node_modules/video.js/dist/video-js.min.css" rel="stylesheet">
    <style>
        #my-player {
            width: 320px;
            height: 180px;
        }

        @media only screen and (min-width: 900px) {
            #my-player {
                width: 640px;
                height: 360px;
            }
        }
</style>
</head>

<body>
    <h1>Hello on the stream !</h1>
    <video id="my-player" class="video-js vjs-big-play-centered">
        Unfortunately, your browser does not support our streaming technologies. Please try in another browser.
    </video>
    <button id="seekToEndButton">Seek to end</button>
    <button id="startStreamingButton">Start streaming</button>
    <button id="stopStreamingButton">Stop streaming</button>

    <script src="node_modules/video.js/dist/video.min.js"></script>
    <script src="node_modules/flv.js/dist/flv.min.js"></script>
    <script src="node_modules/videojs-flvjs/dist/videojs-flvjs.min.js"></script>
    <script type="module">
        import FetchRequest from './helpers/FetchRequest.js';
        import config from './config/config.js';
        const { backendApiUrl, mediaServerUrl } = config;

        const createMediaSourceElement = () => {
            const sourceElement = document.createElement('source');

            sourceElement.src = `${mediaServerUrl}/PiSentry/Spooky_Stream/index.m3u8`;
            sourceElement.type = 'application/x-mpegURL';

            if (flvjs.isSupported()) {
                sourceElement.src = `${mediaServerUrl}/PiSentry/Spooky_Stream.flv`;
                sourceElement.type = 'video/x-flv';
            }

            return sourceElement;
        };

        let myPlayer = null;

        const createPlayerOptions = () => {
            const playerOptions = {
                controls: true,
                playsinline: true,
                userActions: {
                    click: (ev) => {
                        const videoElement = ev.currentTarget;
                        if (videoElement.paused) {
                            console.log('videoElement', videoElement);

                            videoElement.currentTime = myPlayer.liveTracker.seekableEnd() - 0.5;
                            videoElement.play();
                            return;
                        }
                        videoElement.pause();
                    }
                },
                bigPlayButton: true,
                controlBar: {
                    playToggle: false,
                    volumePanel: false,
                    currentTimeDisplay: false,
                    timeDivider: false,
                    durationDisplay: false,
                    progressControl: {
                        seekBar: false
                    },
                    remainingTimeDisplay: false,
                    pictureInPictureToggle: false,
                    fullscreenToggle: true,
                },
            };

            if (flvjs.isSupported()) {
                const flvOptions = {
                    mediaDataSource: {
                        type: "flv",
                        isLive: true,
                        cors: true,
                        withCredentials: false,
                    },
                };

                playerOptions["flvjs"] = flvOptions;
            }

            return playerOptions;
        };

        const playerOptions = createPlayerOptions();
        const mediaSourceElement = createMediaSourceElement();

        const playerElement = document.getElementById('my-player');
        playerElement.appendChild(mediaSourceElement);

        myPlayer = new videojs(playerElement, playerOptions);

        const seekToEndButton = document.getElementById('seekToEndButton');
        seekToEndButton.addEventListener('click', () => {
            // playerElement.currentTime = myPlayer.liveTracker.seekableEnd() - 0.5;
            myPlayer.liveTracker.seekToLiveEdge();
            myPlayer.play();
        });

        const startStreamingButton = document.getElementById('startStreamingButton');
        startStreamingButton.addEventListener('click', () => {
            new FetchRequest(`${backendApiUrl}/v1/streaming/start`)
                .options({ method: 'POST' })
                .make();
        });

        const stopStreamingButton = document.getElementById('stopStreamingButton');
        stopStreamingButton.addEventListener('click', () => {
            new FetchRequest(`${backendApiUrl}/v1/streaming/stop`)
                .options({ method: 'POST' })
                .make();
        });

    // player.ready(function() {
    //     this.play();

    //     this.on("ended", function() {
    //         videojs.log("awww over so soon");
    //     });
    // });
    </script>
</body>
</html>
