<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PiSentry WebApp</title>
    <link href="node_modules/video.js/dist/video-js.min.css" rel="stylesheet">
    <style>
        #my-player {
            width: 320px;
            height: 180px;
        }

        @media only screen and (min-width: 900px) {
            #my-player {
                width: 640px;
                height: 360px;
            }
        }
    </style>

    <link rel="manifest" href="manifest.json">

    <link rel="apple-touch-icon" href="images/apple-icon-180.png">

    <meta name="apple-mobile-web-app-capable" content="yes">

    <link rel="apple-touch-startup-image" href="images/apple-splash-2048-2732.jpg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="images/apple-splash-2732-2048.jpg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="images/apple-splash-1668-2388.jpg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="images/apple-splash-2388-1668.jpg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="images/apple-splash-1536-2048.jpg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="images/apple-splash-2048-1536.jpg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="images/apple-splash-1668-2224.jpg" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="images/apple-splash-2224-1668.jpg" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="images/apple-splash-1620-2160.jpg" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="images/apple-splash-2160-1620.jpg" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="images/apple-splash-1290-2796.jpg" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="images/apple-splash-2796-1290.jpg" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="images/apple-splash-1179-2556.jpg" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="images/apple-splash-2556-1179.jpg" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="images/apple-splash-1284-2778.jpg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="images/apple-splash-2778-1284.jpg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="images/apple-splash-1170-2532.jpg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="images/apple-splash-2532-1170.jpg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="images/apple-splash-1125-2436.jpg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="images/apple-splash-2436-1125.jpg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="images/apple-splash-1242-2688.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="images/apple-splash-2688-1242.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="images/apple-splash-828-1792.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="images/apple-splash-1792-828.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="images/apple-splash-1242-2208.jpg" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="images/apple-splash-2208-1242.jpg" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="images/apple-splash-750-1334.jpg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="images/apple-splash-1334-750.jpg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="images/apple-splash-640-1136.jpg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="images/apple-splash-1136-640.jpg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
</head>

<body>
    <h1>Hello on the stream !</h1>
    <video id="my-player" class="video-js vjs-big-play-centered">
        Unfortunately, your browser does not support our streaming technologies. Please try in another browser.
    </video>
    <button id="subscribePushNotificationsButton">Subscribe to push notification</button>
    <button id="seekToEndButton">Seek to end</button>
    <button id="startStreamingButton">Start streaming</button>
    <button id="stopStreamingButton">Stop streaming</button>

    <p id="subscriptionParagraph"></p>

    <script src="node_modules/video.js/dist/video.min.js"></script>
    <script src="node_modules/flv.js/dist/flv.min.js"></script>
    <script src="node_modules/videojs-flvjs/dist/videojs-flvjs.min.js"></script>
    <script type="module">
        import FetchRequest from './helpers/FetchRequest.js';
        import config from './config/config.js';
        const { backendApiUrl, mediaServerUrl } = config;

        const createMediaSourceElement = () => {
            const sourceElement = document.createElement('source');

            sourceElement.src = `${mediaServerUrl}/PiSentry/Spooky_Stream/index.m3u8`;
            sourceElement.type = 'application/x-mpegURL';

            if (flvjs.isSupported()) {
                sourceElement.src = `${mediaServerUrl}/PiSentry/Spooky_Stream.flv`;
                sourceElement.type = 'video/x-flv';
            }

            return sourceElement;
        };

        let myPlayer = null;

        const createPlayerOptions = () => {
            const playerOptions = {
                controls: true,
                playsinline: true,
                userActions: {
                    click: (ev) => {
                        const videoElement = ev.currentTarget;
                        if (videoElement.paused) {
                            console.log('videoElement', videoElement);

                            videoElement.currentTime = myPlayer.liveTracker.seekableEnd() - 0.5;
                            videoElement.play();
                            return;
                        }
                        videoElement.pause();
                    }
                },
                bigPlayButton: true,
                controlBar: {
                    playToggle: false,
                    volumePanel: false,
                    currentTimeDisplay: false,
                    timeDivider: false,
                    durationDisplay: false,
                    progressControl: {
                        seekBar: false
                    },
                    remainingTimeDisplay: false,
                    pictureInPictureToggle: false,
                    fullscreenToggle: true,
                },
            };

            if (flvjs.isSupported()) {
                const flvOptions = {
                    mediaDataSource: {
                        type: "flv",
                        isLive: true,
                        cors: true,
                        withCredentials: false,
                    },
                };

                playerOptions["flvjs"] = flvOptions;
            }

            return playerOptions;
        };

        const playerOptions = createPlayerOptions();
        const mediaSourceElement = createMediaSourceElement();

        const playerElement = document.getElementById('my-player');
        playerElement.appendChild(mediaSourceElement);

        myPlayer = new videojs(playerElement, playerOptions);

        const seekToEndButton = document.getElementById('seekToEndButton');
        seekToEndButton.addEventListener('click', () => {
            // playerElement.currentTime = myPlayer.liveTracker.seekableEnd() - 0.5;
            myPlayer.liveTracker.seekToLiveEdge();
            myPlayer.play();
        });

        const startStreamingButton = document.getElementById('startStreamingButton');
        startStreamingButton.addEventListener('click', () => {
            new FetchRequest(`${backendApiUrl}/v1/streaming/start`)
                .options({
                    method: 'POST',
                    headers: { Authorization: 'mytoken' }
                })
                .make();
        });

        const stopStreamingButton = document.getElementById('stopStreamingButton');
        stopStreamingButton.addEventListener('click', () => {
            new FetchRequest(`${backendApiUrl}/v1/streaming/stop`)
                .options({
                    method: 'POST',
                    headers: { Authorization: 'mytoken' }
                })
                .make();
        });

    // player.ready(function() {
    //     this.play();

    //     this.on("ended", function() {
    //         videojs.log("awww over so soon");
    //     });
    // });


        /**
         * Push notifications
         */
        document.addEventListener('DOMContentLoaded', async () => {
            if ('serviceWorker' in navigator && 'PushManager' in window) {
                console.log('Service Worker and Push are supported');

                try {
                    const serviceWorkerRegistration = await navigator.serviceWorker.register('./serviceWorker.js');
                    console.log('service worker registration:', serviceWorkerRegistration);
                } catch (err) {
                    console.error('Service Worker Error:', err);
                }
            } else {
                console.warn('Push messaging is not supported');
            }
        });

        const subscribe = async () => {
            try {
                const serviceWorkerRegistration = await navigator.serviceWorker.ready;
                const pushSubscription = await serviceWorkerRegistration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: 'BDMJlhUeJ0cPUbzzGjZpKBhuPV7XoxaCW2RAFY7gIBrg65JIUCE3Ryxutn5NX1FdA5e1w28y45WTi38aqJZ4FSQ' // encoded in Base64
                });

                const subscriptionParagraph = document.getElementById('subscriptionParagraph');
                subscriptionParagraph.textContent = JSON.stringify(pushSubscription);

                console.log(JSON.stringify(pushSubscription));

                // TODO: Send push subscription to the backend to put it in the DB
            } catch (err) {
                console.error(err);
            }
        };

        const subscribePushNotificationsButton = document.getElementById('subscribePushNotificationsButton');
        subscribePushNotificationsButton.addEventListener('click', subscribe);
    </script>
</body>
</html>
